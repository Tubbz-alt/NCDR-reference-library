{% extends "base_templates/form_base.html" %}
{% load bootstrap %}
{% block form_title %}
  <h3>Add {{ view.model.get_model_display_name_plural }}</h3>
{% endblock %}
{% block form_description %}
  {% if view.model.get_form_description_template %}
    <div class="row nhs-england-well">
      {% include view.model.get_form_description_template %}
    </div>
  {% endif %}
{% endblock %}

{% block form_contents %}
<div class="row content-offset">
  <div class="col-md-12">
    <form action="" method="post">
      {% csrf_token %}
      {{ formset.management_form }}
      <div id="items-form-container">
        {% for form in formset.forms %}
          {% if not forloop.first %}
            <hr />
          {% endif %}
          <div class="model-form">
            {% include view.model.get_form_template %}
          </div>
        {% endfor %}
      </div>
      <div class="row">
        <div class="col-md-12 text-right">
          <a href="" id="add-another" class="btn btn-primary">
            Add Another
          </a>
          <a href="{{ view.model.get_edit_list_url }}" class="btn btn-default">
            Cancel
          </a>
          <input class="btn btn-primary" type="submit" value="Submit" />
        </div>
      </div>
    </form>
  </div>

    <script type="text/html" id="record-template">
      <div class="model-form" id="item-__prefix__">
        <hr />
        {% include view.model.get_form_template with form=formset.empty_form %}
      </div>
    </script>
    <script>

    function modelMatcher (params, data) {
      data.parentText = data.parentText || "";

      // Always return the object if there is nothing to compare
      if ($.trim(params.term) === '') {
        return data;
      }

      // Do a recursive check for options with children
      if (data.children && data.children.length > 0) {
        // Clone the data object if there are children
        // This is required as we modify the object to remove any non-matches
        var match = $.extend(true, {}, data);

        // Check each child of the option
        for (var c = data.children.length - 1; c >= 0; c--) {
          var child = data.children[c];
          child.parentText += data.parentText + " " + data.text;

          var matches = modelMatcher(params, child);

          // If there wasn't a match, remove the object in the array
          if (matches == null) {
            match.children.splice(c, 1);
          }
        }

        // If any children matched, return the new object
        if (match.children.length > 0) {
          return match;
        }

        // If there were no matching children, check just the plain object
        return modelMatcher(params, match);
      }

      // If the typed-in term matches the text of this term, or the text from any
      // parent term, then it's a match.
      var original = (data.parentText + ' ' + data.text).toUpperCase();
      var term = params.term.toUpperCase();


      // Check if the text contains the term
      if (original.indexOf(term) > -1) {
        return data;
      }

      // If it doesn't contain the term, don't return anything
      return null;
    }

    $('select[id*="-table"]').each(function(i, v){
      $(v).select2({
        matcher: modelMatcher
      });
    });

    var addAnother = function(){
      var count = $('#items-form-container').children(".model-form").length;
      var tmplMarkup = $('#record-template').html();
      var compiledTmpl = tmplMarkup.replace(/__prefix__/g, count);
      $('div#items-form-container').append(compiledTmpl);

      // update form count
      $('#id_form-TOTAL_FORMS').attr('value', count+1);
    }

    $("#add-another").click(function(e){
      e.preventDefault();
      addAnother();
    });
  </script>
</div>
{% endblock %}
